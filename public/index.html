<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PollCollector</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="box">
    <h1>PollCollector</h1>
    <div class="field">
      <label>Your Name</label>
      <input type="text" id="name" placeholder="e.g. Player123">
    </div>
    <div class="field">
      <label>Choose One</label>
      <select id="choice">
        <option value="hit">H.I.T</option>
        <option value="hvt">High Volume Training</option>
      </select>
    </div>
    <button id="go">Submit Vote</button>

    <div class="results" id="res">
      <div>H.I.T: <span id="p1">0%</span>
        <div class="bar"><div class="inner" id="b1"></div></div>
      </div>
      <div>High Volume: <span id="p2">0%</span>
        <div class="bar"><div class="inner" id="b2"></div></div>
      </div>
      <div class="voters"><strong>Voters:</strong>
        <div id="vn"></div>
      </div>
    </div>
  </div>

  <!-- FingerprintJS -->
  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <script>
    let visitorId = '';
    (async()=> {
      const fp = await FingerprintJS.load();
      const result = await fp.get();
      visitorId = result.visitorId;
    })();

    // Helper to capture canvas fingerprint
    function getCanvasFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgb(120, 186, 176)';
        ctx.fillRect(10, 10, 50, 50);
        return canvas.toDataURL();
      } catch {
        return '';
      }
    }

    // Capture visibility events
    const visibilityEvents = [];
    document.addEventListener('visibilitychange', () => {
      visibilityEvents.push({
        state: document.visibilityState,
        when: new Date().toISOString()
      });
    });

    document.getElementById('go').onclick = async () => {
      const btn = document.getElementById('go');
      const name = document.getElementById('name').value.trim();
      if (!name) return alert('Please enter your name');
      btn.disabled = true;

      const choice = document.getElementById('choice').value;
      const screenData = { width: screen.width, height: screen.height };
      const tzOffset = new Date().getTimezoneOffset();
      const cores = navigator.hardwareConcurrency || null;
      const language = navigator.language || '';
      const battery = await (navigator.getBattery ? (await navigator.getBattery()).level : null);
      const touchSupport = window.matchMedia('(pointer: coarse)').matches;
      const canvasFP = getCanvasFingerprint();

      const payload = {
        name, choice,
        fingerprint: visitorId,
        screen: screenData,
        tzOffset,
        cores,
        battery,
        language,
        touchSupport,
        visibilityEvents,
        canvasFingerprint: canvasFP
      };

      try {
        const res = await fetch('/submit', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();

        // Show rigged results 50/50
        document.getElementById('res').style.display = 'block';
        document.getElementById('p1').textContent = data.hitPercent + '%';
        document.getElementById('p2').textContent = data.hvtPercent + '%';
        document.getElementById('b1').style.width = data.hitPercent + '%';
        document.getElementById('b2').style.width = data.hvtPercent + '%';

        // List voters
        const vn = document.getElementById('vn');
        vn.innerHTML = '';
        data.voters.forEach(n => {
          const el = document.createElement('div');
          el.textContent = n;
          vn.appendChild(el);
        });
      } catch (err) {
        alert('Submission failed: ' + err.message);
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>