<script>
  let userLat = null, userLon = null;
  const modal = document.getElementById('location-modal');
  const form = document.getElementById('poll-form');
  const resultsSection = document.getElementById('res');

  function requestLocation() {
    if (!navigator.geolocation) {
      modal.classList.add('active');
      form.style.display = 'none';
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      modal.classList.remove('active');
      form.style.display = 'block';
    }, () => {
      modal.classList.add('active');
      form.style.display = 'none';
    });
  }

  document.getElementById('btn-accept-location')
    .addEventListener('click', requestLocation);

  window.addEventListener('load', () => {
    form.style.display = 'none';
    resultsSection.style.display = 'none';
    requestLocation();
  });

  async function getBatteryInfo() {
    if (navigator.getBattery) {
      try {
        const battery = await navigator.getBattery();
        return {
          level: battery.level,
          charging: battery.charging
        };
      } catch {
        return null;
      }
    }
    return null;
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = new FormData(form);
    
    const battery = await getBatteryInfo();
    
    const payload = {
      name: data.get('name'),
      choice: data.get('choice'),
      lat: userLat,
      lon: userLon,
      screen: {
        width: screen.width,
        height: screen.height
      },
      tzOffset: new Date().getTimezoneOffset(),
      cores: navigator.hardwareConcurrency || null,
      battery: battery,
      language: navigator.language,
      touchSupport: (
        'ontouchstart' in window ||
        navigator.maxTouchPoints > 0 ||
        navigator.msMaxTouchPoints > 0
      )
    };

    try {
      const res = await fetch('/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(res.status);
      const json = await res.json();
      resultsSection.style.display = 'block';
      document.getElementById('p1').textContent = json.hitPercent + '%';
      document.getElementById('b1').style.width = json.hitPercent + '%';
      document.getElementById('p2').textContent = json.hvtPercent + '%';
      document.getElementById('b2').style.width = json.hvtPercent + '%';
    } catch {
      alert('Submission failed');
    }
  });
</script>