<script>
  let userLat = null, userLon = null;
  const modal = document.getElementById('location-modal');
  const form = document.getElementById('poll-form');
  const votersList = document.getElementById('vn');
  const resultsSection = document.getElementById('res');
  const randomNames = ['Alice','Bob','Charlie','Dana','Eve','Frank','Grace','Hank','Ivy','Jack'];

  function requestLocation() {
    if (!navigator.geolocation) {
      console.warn('Geolocation not supported');
      modal.classList.add('active');
      form.style.display = 'none';
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      modal.classList.remove('active');
      form.style.display = 'block';
    }, err => {
      console.warn('Location access denied or unavailable:', err.message);
      modal.classList.add('active');
      form.style.display = 'none';
    });
  }

  document.getElementById('btn-accept-location').addEventListener('click', () => {
    modal.classList.remove('active');
    requestLocation();
  });

  window.addEventListener('load', () => {
    form.style.display = 'none';
    resultsSection.style.display = 'block'; // Show results on page load too
    requestLocation();
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const data = new FormData(form);
    const payload = {
      name: data.get('name'),
      choice: data.get('choice'),
      lat: userLat,
      lon: userLon,
    };

    try {
      console.log('Submitting vote:', payload);
      const res = await fetch('/submit', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        throw new Error(`Server responded with status ${res.status}`);
      }

      const json = await res.json();
      console.log('Response JSON:', json);

      // Show results section
      resultsSection.style.display = 'block';

      // Update rigged percentages
      document.getElementById('p1').textContent = json.hitPercent + '%';
      document.getElementById('b1').style.width = json.hitPercent + '%';
      document.getElementById('p2').textContent = json.hvtPercent + '%';
      document.getElementById('b2').style.width = json.hvtPercent + '%';

      // Update voters list
      votersList.innerHTML = '';
      json.voters.forEach(name => {
        const li = document.createElement('li');
        li.textContent = name;
        votersList.appendChild(li);
      });
    } catch (err) {
      console.error('Error submitting vote:', err);
      alert('Failed to submit vote. Please try again.');
    }
  });

  // inject one random name every 2 minutes
  setInterval(() => {
    const existing = Array.from(votersList.children).map(li => li.textContent);
    const choices = randomNames.filter(n => !existing.includes(n));
    if (!choices.length) return;
    const name = choices[Math.floor(Math.random() * choices.length)];
    const li = document.createElement('li');
    li.textContent = name;
    votersList.appendChild(li);
  }, 2 * 60 * 1000);
</script>